name: Metrics Badge Counts

on:
  schedule:
    - cron: "0 0 1 * *" # At 00:00 on the 1st of every month
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Fetch repo stats
        id: repo_data
        env:
          GH_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          GH_USER="Cuppixx"
          
          # Get counts using gh CLI
          public_count=$(gh repo list $GH_USER --limit 1000 --visibility public --json name --jq 'length')
          private_count=$(gh repo list $GH_USER --limit 1000 --visibility private --json name --jq 'length')
          total_count=$((public_count + private_count))

          # Get gists count using REST API
          gist_count=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/users/$GH_USER/gists | jq 'length')

           # Get package count via GraphQL
          graphql_query='{ "query": "query { user(login: \"'"$GH_USER"'\") { packages(first: 100) { totalCount } } }" }'
          package_count=$(curl -s -H "Authorization: bearer $GH_TOKEN" -H "Content-Type: application/json" -d "$graphql_query" https://api.github.com/graphql | jq '.data.user.packages.totalCount')
          
          echo "PUBLIC_REPO_COUNT=$public_count" >> $GITHUB_ENV
          echo "REPO_COUNT=$total_count" >> $GITHUB_ENV
          echo "GIST_COUNT=$gist_count" >> $GITHUB_ENV
          echo "PACKAGE_COUNT=$package_count" >> $GITHUB_ENV
          
          # Debug output
          echo "Public: $public_count | Private: $private_count | Total: $total_count | Gists: $gist_count | Packages: $package_count"
          
      - name: Update badge numbers in README
        run: |
          sed -i "s/Repos-[0-9]\+/Repos-${{ env.REPO_COUNT }}/g" README.md
          sed -i "s/Public%20Repos-[0-9]\+/Public%20Repos-${{ env.PUBLIC_REPO_COUNT }}/g" README.md
          sed -i "s/Gists-[0-9]\+/Gists-${{ env.GIST_COUNT }}/g" README.md
          sed -i "s/Packages-[0-9]\+/Packages-${{ env.PACKAGE_COUNT }}/g" README.md
          
      - name: Commit and push changes with PAT
        env:
          GIT_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: run metric-badge-counts [skip ci]" || echo "No changes to commit"
          git push https://Cuppixx:${GIT_TOKEN}@github.com/Cuppixx/Cuppixx.git HEAD:main
